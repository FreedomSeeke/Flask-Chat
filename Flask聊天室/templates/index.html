<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>flask聊天系统 - {{ current_user.username }}</title>
    <!-- Favicon图标 -->
    <link rel="icon" href="{{ url_for('static', filename='images/❤.png') }}" type="image/x-icon">
    <!-- 引入Font-Awesome图标 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            height: 100vh;
            background: #f5f5f5;
            font-family: "Microsoft YaHei", sans-serif;
        }
        /* 左侧联系人面板 */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        /* 聊天页面Logo */
        .sidebar-logo {
            display: flex;
            align-items: center;
        }
        .sidebar-logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .sidebar-title {
            font-size: 18px;
            color: #333;
        }
        .logout-link {
            color: #ff3b30;
            text-decoration: none;
            font-size: 14px;
        }
        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .contact-item {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .contact-item:hover {
            background: #f5f5f5;
        }
        .contact-item.online::before {
            content: "";
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #07C160;
            margin-right: 10px;
        }
        .contact-item.offline::before {
            content: "";
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #999;
            margin-right: 10px;
        }
        /* 右侧聊天面板 */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-title {
            font-size: 18px;
            color: #333;
        }
        .chat-tools {
            display: flex;
            gap: 10px;
        }
        .search-input {
            padding: 5px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            outline: none;
            width: 200px;
            /* 默认禁用搜索 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            /* 默认禁用按钮 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-search {
            background: #1677ff;
            color: white;
        }
        .btn-clear {
            background: #ff3b30;
            color: white;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
        }
        .message-item.self {
            margin-left: auto;
        }
        .message-content {
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        .message-item.other .message-content {
            background: white;
            border: 1px solid #e0e0e0;
            border-top-left-radius: 0;
        }
        .message-item.self .message-content {
            background: #07C160;
            color: white;
            border-top-right-radius: 0;
        }
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }
        .file-message {
            width: 200px;
            border-radius: 5px;
            overflow: hidden;
        }
        .file-message img {
            width: 100%;
            height: auto;
            cursor: pointer;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            outline: none;
            resize: none;
            height: 50px;
            /* 默认禁用输入框 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-send {
            background: #07C160;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* 默认禁用发送按钮 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        .file-btn {
            font-size: 20px;
            color: #1677ff;
            cursor: pointer;
            /* 默认禁用文件按钮 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        #file-input {
            display: none;
        }
        .empty-tip {
            text-align: center;
            color: #999;
            margin-top: 50px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- 左侧联系人面板 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <!-- 聊天页面Logo -->
            <div class="sidebar-logo">
                <img src="{{ url_for('static', filename='images/❤.png') }}" class="sidebar-logo-img" alt="Logo">
                <span class="sidebar-title">当前登录：{{ current_user.username }}</span>
            </div>
            <a href="/logout" class="logout-link">退出</a>
        </div>
        <div class="contact-list" id="contact-list">
            {% for user in users %}
                <div class="contact-item {{ 'online' if user.online else 'offline' }}"
                     data-user-id="{{ user.id }}"
                     data-username="{{ user.username }}">
                    {{ user.username }}
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- 右侧聊天面板 -->
    <div class="chat-panel">
        <div class="chat-header">
            <div class="chat-title" id="chat-title">请选择联系人开始聊天</div>
            <div class="chat-tools">
                <input type="text" class="search-input" id="search-input" placeholder="输入关键词搜索聊天记录" disabled>
                <button class="btn btn-search" id="search-btn" disabled>搜索</button>
                <button class="btn btn-clear" id="clear-btn" disabled>清空记录</button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="empty-tip">请选择左侧联系人开始聊天</div>
        </div>
        <!-- 修复：聊天输入框移到消息区域外 -->
        <div class="chat-input">
            <label for="file-input" class="file-btn" id="file-btn" disabled>
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="file-input" accept="image/*,audio/*" disabled>
            <textarea class="input-box" id="message-input" placeholder="{{ '您已被禁言，无法发送消息' if is_muted else '请输入消息...' }}" disabled></textarea>
            <button class="btn-send" id="send-btn" disabled>发送</button>
        </div>
    </div>

    <!-- 引入SocketIO和jQuery -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let currentReceiverId = null;
        let currentReceiverName = null;
        const currentUserId = {{ current_user.id }};
        const isMuted = {{ is_muted | tojson }}; // 禁言状态转为JS布尔值
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // 初始化禁用状态
        function setDisabledState(disabled) {
            // 搜索/清空按钮
            $('#search-input').prop('disabled', disabled);
            $('#search-btn').prop('disabled', disabled);
            $('#clear-btn').prop('disabled', disabled);
            // 输入框/发送按钮
            $('#message-input').prop('disabled', disabled || isMuted);
            $('#send-btn').prop('disabled', disabled || isMuted);
            $('#file-btn').prop('disabled', disabled || isMuted);
            $('#file-input').prop('disabled', disabled || isMuted);

            // 样式切换
            const opacity = disabled || isMuted ? 0.5 : 1;
            const cursor = disabled || isMuted ? 'not-allowed' : 'pointer';

            $('#search-input, #search-btn, #clear-btn').css({
                'opacity': opacity,
                'cursor': cursor
            });
            $('#message-input, #send-btn, #file-btn, #file-input').css({
                'opacity': opacity,
                'cursor': cursor
            });

            // 更新输入框提示
            if (isMuted) {
                $('#message-input').attr('placeholder', '您已被禁言，无法发送消息');
            } else if (disabled) {
                $('#message-input').attr('placeholder', '请选择联系人开始聊天');
            } else {
                $('#message-input').attr('placeholder', '请输入消息...');
            }
        }

        // 加载联系人列表
        function loadContacts() {
            $.get('/get_contacts', function(users) {
                const contactList = $('#contact-list');
                contactList.empty();
                users.forEach(user => {
                    contactList.append(`
                        <div class="contact-item ${user.online ? 'online' : 'offline'}"
                             data-user-id="${user.id}"
                             data-username="${user.username}">
                            ${user.username}
                        </div>
                    `);
                });
                bindContactClick();
            });
        }

        // 绑定联系人点击事件
        function bindContactClick() {
            $('.contact-item').click(function() {
                currentReceiverId = $(this).data('user-id');
                currentReceiverName = $(this).data('username');
                $('#chat-title').text(currentReceiverName);
                // 启用输入框和按钮
                setDisabledState(false);
                // 加载历史消息
                loadMessages();
            });
        }

        // 加载历史消息
        function loadMessages() {
            $.get(`/get_messages/${currentReceiverId}`, function(messages) {
                const messagesContainer = $('#chat-messages');
                messagesContainer.empty();
                if (messages.length === 0) {
                    messagesContainer.html('<div class="empty-tip">暂无聊天记录</div>');
                    return;
                }
                messages.forEach(msg => {
                    addMessageToDOM(msg);
                });
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            });
        }

        // 添加消息到DOM
        function addMessageToDOM(msg) {
            const messagesContainer = $('#chat-messages');
            const isSelf = msg.sender_id === currentUserId;
            let messageHtml = '';

            // 移除空提示
            messagesContainer.find('.empty-tip').remove();

            if (msg.content) {
                // 文字消息
                messageHtml = `
                    <div class="message-item ${isSelf ? 'self' : 'other'}">
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>
                `;
            } else if (msg.file_type) {
                // 文件消息
                if (msg.file_type === 'image') {
                    messageHtml = `
                        <div class="message-item ${isSelf ? 'self' : 'other'}">
                            <div class="message-content">
                                <div class="file-message">
                                    <img src="${msg.file_path}" alt="图片" onclick="window.open(this.src)">
                                </div>
                            </div>
                            <div class="message-time">${msg.timestamp}</div>
                        </div>
                    `;
                } else if (msg.file_type === 'audio') {
                    messageHtml = `
                        <div class="message-item ${isSelf ? 'self' : 'other'}">
                            <div class="message-content">
                                <audio controls src="${msg.file_path}">
                                    您的浏览器不支持音频播放
                                </audio>
                            </div>
                            <div class="message-time">${msg.timestamp}</div>
                        </div>
                    `;
                }
            }
            messagesContainer.append(messageHtml);
            // 滚动到最新消息
            messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        }

        // 发送文字消息
        $('#send-btn').click(function() {
            sendTextMessage();
        });

        $('#message-input').keydown(function(e) {
            // 按Enter直接发送（更符合习惯）
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止换行
                sendTextMessage();
            }
        });

        function sendTextMessage() {
            const content = $('#message-input').val().trim();
            if (!content || !currentReceiverId || isMuted) return;

            // 构建当前消息对象，实时添加到自己的DOM
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const selfMsg = {
                sender_id: currentUserId,
                content: content,
                timestamp: timestamp
            };
            addMessageToDOM(selfMsg); // 立即显示到自己的聊天面板

            // 发送给后端（持久化+推送给接收方）
            socket.emit('send_text_message', {
                receiver_id: currentReceiverId,
                content: content
            });
            $('#message-input').val('');
        }

        // 发送文件消息
        $('#file-input').change(function() {
            const file = this.files[0];
            if (!file || !currentReceiverId || isMuted) return;

            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/upload_file',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.code === 1) {
                        // 构建文件消息对象，实时添加到自己的DOM
                        const now = new Date();
                        const timestamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                        const selfFileMsg = {
                            sender_id: currentUserId,
                            file_type: res.data.file_type,
                            file_path: res.data.file_path,
                            timestamp: timestamp
                        };
                        addMessageToDOM(selfFileMsg); // 立即显示到自己的聊天面板

                        // 发送给后端（推送给接收方）
                        socket.emit('send_file_message', {
                            receiver_id: currentReceiverId,
                            file_type: res.data.file_type,
                            file_path: res.data.file_path
                        });
                    } else {
                        alert(res.msg);
                    }
                },
                error: function() {
                    alert('文件上传失败');
                }
            });
            $(this).val('');
        });

        // 接收消息
        socket.on('receive_message', function(msg) {
            // 仅当当前选中的是消息发送者时，加载消息
            if (currentReceiverId && (msg.sender_id === currentReceiverId || msg.receiver_id === currentReceiverId)) {
                addMessageToDOM(msg); // 直接添加，无需重新加载所有历史消息
            }
        });

        // 监听消息发送错误
        socket.on('message_error', function(data) {
            alert(data.msg);
        });

        // 搜索聊天记录
        $('#search-btn').click(function() {
            const keyword = $('#search-input').val().trim();
            if (!keyword || !currentReceiverId) return;

            $.get(`/search_messages/${currentReceiverId}?keyword=${keyword}`, function(res) {
                const messagesContainer = $('#chat-messages');
                messagesContainer.empty();
                if (res.code === 0) {
                    messagesContainer.html(`<div class="empty-tip">${res.msg}</div>`);
                    return;
                }
                messagesContainer.html(`<div class="empty-tip">找到${res.data.length}条结果</div>`);
                res.data.forEach(msg => {
                    if (msg.content) {
                        // 关键词高亮
                        const highlightedContent = msg.content.replace(new RegExp(keyword, 'g'), `<span style="color:red">${keyword}</span>`);
                        const isSelf = msg.sender_id === currentUserId;
                        const messageHtml = `
                            <div class="message-item ${isSelf ? 'self' : 'other'}">
                                <div class="message-content">${highlightedContent}</div>
                                <div class="message-time">${msg.timestamp}</div>
                            </div>
                        `;
                        messagesContainer.append(messageHtml);
                    }
                });
            });
        });

        // 清空聊天记录
        $('#clear-btn').click(function() {
            if (!currentReceiverId) return;
            if (confirm(`确定要清空与${currentReceiverName}的所有聊天记录吗？此操作不可恢复！`)) {
                $.ajax({
                    url: `/clear_messages/${currentReceiverId}`,
                    type: 'POST',
                    success: function(res) {
                        if (res.code === 1) {
                            const messagesContainer = $('#chat-messages');
                            messagesContainer.empty();
                            messagesContainer.html('<div class="empty-tip">暂无聊天记录</div>');
                            alert(res.msg);
                        }
                    }
                });
            }
        });

        // 页面加载初始化
        $(document).ready(function() {
            // 初始状态禁用所有输入/按钮
            setDisabledState(true);
            loadContacts();
            bindContactClick();
        });

        // SocketIO连接成功刷新联系人状态
        socket.on('connect', function() {
            loadContacts();
        });
    </script>
</body>
</html>